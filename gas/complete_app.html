<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="robots" content="noindex, nofollow">
    <title>„Éõ„ÉÜ„É©„Éê presents Quiz‚òÜ„Ç´„É©„Ç≥„É≥„Ç¢„Ç´„Éá„Éü„Ç¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(180deg, #fff2f7, #fffafc);
            min-height: 100vh;
            padding: 20px;
        }

        .shell {
            max-width: 480px;
            margin: 0 auto;
        }

        .hero {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 12px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .logo {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FF6EC7, #FF9472);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        h1 {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .api {
            color: #999;
            font-size: 12px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #FF6EC7;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6EC7, #FF9472);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* „ÇØ„Ç§„Ç∫ÁîªÈù¢ */
        .quiz-header {
            background: linear-gradient(135deg, #FF6EC7, #FF9472);
            color: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timer {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .timer.warning {
            background: #FF4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.5s ease;
        }

        /* „É¨„É≥„Ç∫Ë°®Á§∫ */
        .lens-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .lens-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .lens-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .lens-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            object-fit: cover;
            border: 3px solid #FFD2EC;
        }

        /* „Éí„É≥„Éà„Éú„Çø„É≥ */
        .hint-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .hint-btn {
            flex: 1;
            padding: 12px;
            background: #FFF0F8;
            border: 2px solid #FFD2EC;
            border-radius: 12px;
            color: #FF6EC7;
            cursor: pointer;
            font-weight: bold;
        }

        .hint-btn.used {
            background: #FFD2EC;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hint-display {
            display: none;
            background: #FFF9E6;
            border: 2px solid #FFE59E;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            color: #8B6914;
            font-size: 14px;
            white-space: pre-line;
        }

        .hint-display.show {
            display: block;
        }

        /* ÈÅ∏ÊäûËÇ¢ */
        .answer-options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .answer-option {
            background: white;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-option:hover {
            border-color: #FF6EC7;
            background: #FFF0F8;
        }

        .answer-option.selected {
            border-color: #FF6EC7;
            background: #FFE3F2;
        }

        .answer-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #E0E0E0;
            border-radius: 50%;
            position: relative;
        }

        .answer-option.selected .answer-radio {
            border-color: #FF6EC7;
        }

        .answer-option.selected .answer-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #FF6EC7;
            border-radius: 50%;
        }

        .hidden {
            display: none !important;
        }

        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .feedback-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
            margin: 20px;
        }

        .feedback-correct {
            border: 4px solid #4CAF50;
        }

        .feedback-incorrect {
            border: 4px solid #F44336;
        }

        .feedback-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="shell">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="hero">
            <div class="logo">üëÅÔ∏è</div>
            <div>
                <h1>Quiz‚òÜ„Ç´„É©„Ç≥„É≥„Ç¢„Ç´„Éá„Éü„Ç¢</h1>
                <div class="api">„Éõ„ÉÜ„É©„Éê presents v1.5</div>
            </div>
        </div>

        <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
        <div id="loginPage" class="page">
            <div class="card">
                <h2 style="margin-bottom: 20px;">„Çπ„Çø„ÉÉ„Éï„É≠„Ç∞„Ç§„É≥</h2>
                <div class="input-group">
                    <label for="staffId">„Çπ„Çø„ÉÉ„ÉïÁï™Âè∑</label>
                    <input type="text" id="staffId" name="staffId" placeholder="‰æãÔºöST001" value="ST001" autocomplete="username" aria-describedby="staffId-help">
                    <small id="staffId-help" style="color: #666; font-size: 12px;">‰æãÔºöST001</small>
                </div>
                <div class="input-group">
                    <label for="userName">„ÅäÂêçÂâç</label>
                    <input type="text" id="userName" name="userName" placeholder="‰æãÔºöÂ±±Áî∞Ëä±Â≠ê" value="„ÉÜ„Çπ„Éà„É¶„Éº„Ç∂„Éº" autocomplete="name" aria-describedby="userName-help">
                    <small id="userName-help" style="color: #666; font-size: 12px;">„Éï„É´„Éç„Éº„É†„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                </div>
                <button id="loginBtn" class="btn btn-primary" type="button" aria-label="„Çπ„Çø„ÉÉ„ÉïÊÉÖÂ†±„Åß„É≠„Ç∞„Ç§„É≥„Åô„Çã">„É≠„Ç∞„Ç§„É≥</button>
            </div>
        </div>

        <!-- „Éõ„Éº„É†ÁîªÈù¢ -->
        <div id="homePage" class="page hidden">
            <div class="card" style="background: linear-gradient(135deg, #FF6EC7, #FF9472); color: white;">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <div style="width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">üë§</div>
                    <div>
                        <div style="font-size: 20px; font-weight: bold;" id="displayName">-</div>
                        <div style="font-size: 14px;">Lv.5 „Çπ„Çø„ÉÉ„Éï</div>
                    </div>
                </div>
                <div class="stats-grid" style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 12px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="userPoints">850</div>
                        <div style="font-size: 12px;">„Éù„Ç§„É≥„Éà</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="userStreak">7Êó•</div>
                        <div style="font-size: 12px;">ÈÄ£Á∂ö</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="todayBest">-</div>
                        <div style="font-size: 12px;">Êú¨Êó•</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <button id="startDailyBtn" class="btn btn-primary" type="button" aria-label="„Éá„Ç§„É™„Éº„ÉÅ„É£„É¨„É≥„Ç∏„ÇíÈñãÂßã„Åô„Çã - 1Êó•1ÂõûÈôêÂÆö„ÅÆÊú¨Áï™„É¢„Éº„Éâ">üìÖ „Éá„Ç§„É™„Éº„ÉÅ„É£„É¨„É≥„Ç∏</button>
                    <button id="startPracticeBtn" class="btn" type="button" style="background: #E3F2FD; color: #1565C0; border: 2px solid #90CAF9;" aria-label="Á∑¥Áøí„É¢„Éº„Éâ„ÇíÈñãÂßã„Åô„Çã - ÁÑ°Âà∂Èôê„ÅßÁ∑¥Áøí„Åß„Åç„Åæ„Åô">üéØ Á∑¥Áøí„É¢„Éº„Éâ</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button id="rankingBtn" class="btn" type="button" style="background: #FFF3E0; color: #F57C00; border: 2px solid #FFB74D;" aria-label="„É©„É≥„Ç≠„É≥„Ç∞„ÇíË°®Á§∫„Åô„Çã - ÂÖ®„Çπ„Çø„ÉÉ„Éï„ÅÆÊàêÁ∏æÈ†Ü‰Ωç">üèÜ „É©„É≥„Ç≠„É≥„Ç∞</button>
                    <button id="myPageBtn" class="btn" type="button" style="background: #F3E5F5; color: #7B1FA2; border: 2px solid #CE93D8;" aria-label="„Éû„Ç§ÊàêÁ∏æ„ÇíË°®Á§∫„Åô„Çã - ÂÄã‰∫∫„ÅÆÁµ±Ë®à„Å®Â±•Ê≠¥">üìä „Éû„Ç§ÊàêÁ∏æ</button>
                </div>
            </div>
        </div>

        <!-- „ÇØ„Ç§„Ç∫ÁîªÈù¢ -->
        <div id="quizPage" class="page hidden">
            <div class="quiz-header">
                <div class="quiz-info">
                    <div>Question <span id="currentQuestionNum">1</span>/10</div>
                    <div class="timer" id="timer">
                        <span>‚è±</span>
                        <span id="timeLeft">20</span>Áßí
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 10%;"></div>
                </div>
            </div>

            <div class="card">
                <div class="lens-container">
                    <div class="lens-label">„Åì„ÅÆ„Ç´„É©„Ç≥„É≥„ÅØ‰ΩïÔºü</div>
                    <div class="lens-display">
                        <img class="lens-image" id="leftLens" src="" alt="Â∑¶„É¨„É≥„Ç∫">
                        <img class="lens-image" id="rightLens" src="" alt="Âè≥„É¨„É≥„Ç∫">
                    </div>
                </div>

                <div class="hint-buttons">
                    <button class="hint-btn" id="hint1Btn" type="button" aria-label="„Éí„É≥„Éà1„ÇíË°®Á§∫„Åô„Çã - DIA„ÄÅG.DIA„ÄÅBC„ÅÆÊÉÖÂ†±">üí° „Éí„É≥„Éà1</button>
                    <button class="hint-btn" id="hint2Btn" type="button" aria-label="„Éí„É≥„Éà2„ÇíË°®Á§∫„Åô„Çã - ÂïÜÂìÅ„ÅÆË©≥Á¥∞„Ç≥„É°„É≥„Éà">üí° „Éí„É≥„Éà2</button>
                </div>

                <div class="hint-display" id="hintDisplay"></div>

                <div class="answer-options" id="answerOptions">
                    <!-- ÈÅ∏ÊäûËÇ¢„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                </div>

                <button class="btn btn-primary" id="submitBtn" type="button" aria-label="ÈÅ∏Êäû„Åó„ÅüÂõûÁ≠î„ÇíÈÄÅ‰ø°„Åô„Çã">ÂõûÁ≠î„Åô„Çã</button>
            </div>
        </div>

        <!-- ÁµêÊûúÁîªÈù¢ -->
        <div id="resultPage" class="page hidden">
            <div class="card" style="text-align: center;">
                <h2 style="color: #FF6EC7; margin-bottom: 20px;">„ÇØ„Ç§„Ç∫ÂÆå‰∫ÜÔºÅ</h2>
                <div style="font-size: 48px; margin: 20px 0;">üéâ</div>
                <p style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                    „Çπ„Ç≥„Ç¢: <span id="finalScore">0</span>ÁÇπ
                </p>
                <p style="color: #666; margin-bottom: 20px;">
                    10Âïè‰∏≠ <span id="correctCount">0</span>ÂïèÊ≠£Ëß£
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-primary" type="button" onclick="showPage('homePage')" aria-label="„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çã">„Éõ„Éº„É†„Å∏Êàª„Çã</button>
                    <button class="btn" type="button" style="background: #E3F2FD; color: #1565C0;" onclick="restartQuiz()" aria-label="Âêå„Åò„É¢„Éº„Éâ„Åß„ÇØ„Ç§„Ç∫„Çí„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§„Åô„Çã">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                </div>
            </div>
        </div>

        <!-- „É©„É≥„Ç≠„É≥„Ç∞ÁîªÈù¢ -->
        <div id="rankingPage" class="page hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üèÜ „É©„É≥„Ç≠„É≥„Ç∞</h2>
                <div id="rankingList"></div>
                <button class="btn btn-primary" type="button" onclick="showPage('homePage')" aria-label="„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çã">„Éõ„Éº„É†„Å∏Êàª„Çã</button>
            </div>
        </div>

        <!-- „Éû„Ç§ÊàêÁ∏æÁîªÈù¢ -->
        <div id="myPage" class="page hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">üìä „Éû„Ç§ÊàêÁ∏æ</h2>
                <div id="myStats"></div>
                <button class="btn btn-primary" type="button" onclick="showPage('homePage')" aria-label="„Éõ„Éº„É†ÁîªÈù¢„Å´Êàª„Çã">„Éõ„Éº„É†„Å∏Êàª„Çã</button>
            </div>
        </div>

        <!-- „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫ -->
        <div id="feedbackOverlay" class="feedback-overlay hidden">
            <div class="feedback-card" id="feedbackCard">
                <div class="feedback-icon" id="feedbackIcon">üéâ</div>
                <div id="feedbackTitle" style="font-size: 24px; font-weight: bold; margin-bottom: 12px;">Ê≠£Ëß£ÔºÅ</div>
                <div id="feedbackMessage" style="color: #666;">„Çà„Åè„Åß„Åç„Åæ„Åó„Åü</div>
                <div id="feedbackImage" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Êó©Êúü„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞ - ChromeÊã°ÂºµÊ©üËÉΩ„Ç®„É©„Éº„ÇíÁÑ°ÂäπÂåñ
        (function() {
            // Chrome runtime „Ç®„É©„Éº„ÇíÊçïÊçâ„Åó„Å¶ÁÑ°Ë¶ñÔºàÊã°ÂºµÊ©üËÉΩ„Åå„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Çã„Åæ„Åß„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÔºâ
            // ÈÄöÂ∏∏„ÅÆWeb„Éö„Éº„Ç∏„Åß„ÅØ chrome.runtime „ÅØ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì
            /*
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                const originalAddListener = chrome.runtime.onMessage ? chrome.runtime.onMessage.addListener : null;
                if (originalAddListener) {
                    chrome.runtime.onMessage.addListener = function(callback) {
                        return originalAddListener.call(this, function(request, sender, sendResponse) {
                            try {
                                const result = callback(request, sender, sendResponse);
                                if (result === true) {
                                    return true; // ÈùûÂêåÊúü„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
                                }
                                return result;
                            } catch (e) {
                                console.warn('Message listener error caught and ignored:', e);
                                return false;
                            }
                        });
                    };
                }
            }
            */

            // „Ç≥„É≥„ÇΩ„Éº„É´„Ç®„É©„Éº„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const originalError = console.error;
            console.error = function(...args) {
                const message = String(args[0] || '');
                if (message.includes('runtime.lastError') ||
                    message.includes('extension port') ||
                    message.includes('message port closed') ||
                    message.includes('back/forward cache') ||
                    message.includes('Unrecognized feature') ||
                    message.includes('sandbox')) {
                    return;
                }
                originalError.apply(console, args);
            };

            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = String(args[0] || '');
                if (message.includes('Unrecognized feature') ||
                    message.includes('sandbox') ||
                    message.includes('iframe')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentUser = null;
        let quizData = null;
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let answers = [];
        let timer = null;
        let timeLeft = 20;
        let hintsUsed = { h1: false, h2: false };
        let quizId = null;
        let gameMode = 'practice';

        // „Éö„Éº„Ç∏Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(function(page) {
                page.classList.add('hidden');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
        }

        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        function handleLogin() {
            console.log('„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜÈñãÂßã');

            const staffId = document.getElementById('staffId').value.trim();
            const userName = document.getElementById('userName').value.trim();

            if (!staffId || !userName) {
                alert('„Çπ„Çø„ÉÉ„ÉïÁï™Âè∑„Å®„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            currentUser = {
                staffId: staffId,
                name: userName,
                role: 'role_baito'
            };

            document.getElementById('displayName').textContent = userName;
            showPage('homePage');

            console.log('„É≠„Ç∞„Ç§„É≥ÊàêÂäü:', currentUser);
        }

        // „ÉÄ„Éü„Éº„ÇØ„Ç§„Ç∫„Éá„Éº„ÇøÁîüÊàê
        function generateDummyQuestions() {
            const questions = [];
            const sampleOptions = [
                '„ÉÄ„Çπ„ÉÜ„Ç£„ÉÜ„Ç£„ÉºÔΩúÁãÇÊÑõ„Éñ„É©„Ç¶„É≥',
                '„Ç¢„Ç§„ÇØ„É≠„Éº„Çº„ÉÉ„ÉàÔΩú„Éõ„É≠„Éñ„É©„Ç¶„É≥',
                '„Éè„Éã„Éº„Ç≠„ÇπÔΩú„Å°„ÇÖ„Çã„Çì„Éñ„É©„Ç¶„É≥',
                '„Éü„Éº„ÇØ„É¨„Éº„É´ÔΩú„ÅÇ„Åñ„Å®„Éñ„É©„Ç¶„É≥'
            ];

            for (let i = 0; i < 10; i++) {
                const correctIndex = Math.floor(Math.random() * sampleOptions.length);
                const correctLabel = sampleOptions[correctIndex];

                // ÈÅ∏ÊäûËÇ¢„Çí„Ç∑„É£„ÉÉ„Éï„É´
                const shuffledOptions = [...sampleOptions].sort(() => Math.random() - 0.5);

                questions.push({
                    qid: `q${String(i+1).padStart(3, '0')}`,
                    correctAnswer: correctIndex,
                    correctLabel: correctLabel,
                    imageUrl: 'https://via.placeholder.com/150/FFB6C1/000000?text=Lens${i+1}',
                    thumbUrl: 'https://via.placeholder.com/80/90CAF9/000000?text=OK${i+1}',
                    options: shuffledOptions.map((label, idx) => ({
                        oid: `o${String(idx+1).padStart(3, '0')}`,
                        label: label,
                        isCorrect: label === correctLabel
                    })),
                    hints: {
                        h1: `DIA:14.${3+i%8} / G.DIA:13.${2+i%6} / BC:8.${4+i%4}`,
                        h2: ['„Éï„ÉÅ„ÅßÁû≥„Çí„Åè„Å£„Åç„ÇäË¶ã„Åõ„Å§„Å§„ÄÅ‰∏≠ÂøÉÈÉ®„ÅÆÈÄèÊòéÊÑü„Åß„Äå„ÅÜ„Çã„ÉÑ„É§„ÄçÂäπÊûú„ÇíÊºîÂá∫',
                             '„Éä„ÉÅ„É•„É©„É´„Å™Áô∫Ëâ≤„ÅßÁû≥„Å´Ê∫∂„ÅëËæº„ÇÄ„Çà„ÅÜ„Å™„Éá„Ç∂„Ç§„É≥',
                             'Â§ß‰∫∫„Å£„ÅΩ„ÅÑÂç∞Ë±°„Çí‰∏é„Åà„ÇãËêΩ„Å°ÁùÄ„ÅÑ„Åü„Ç´„É©„Éº',
                             'ÂèØÊÑõ„Çâ„Åó„Åï„ÇíÊºîÂá∫„Åô„ÇãÁîò„ÇÅ„ÅÆÁô∫Ëâ≤'][i%4]
                    }
                });
            }

            return questions;
        }

        // „ÇØ„Ç§„Ç∫ÈñãÂßã
        function startQuiz(mode = 'practice') {
            console.log('„ÇØ„Ç§„Ç∫ÈñãÂßã:', mode);
            gameMode = mode;

            quizData = generateDummyQuestions();
            quizId = 'quiz_' + Date.now();
            currentQuestionIndex = 0;
            answers = [];

            showPage('quizPage');
            loadQuestion();
        }

        // ÂïèÈ°åË™≠„ÅøËæº„Åø
        function loadQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                finishQuiz();
                return;
            }

            const question = quizData[currentQuestionIndex];

            // ÂïèÈ°åÁï™Âè∑Êõ¥Êñ∞
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('progressFill').style.width = `${((currentQuestionIndex + 1) / 10) * 100}%`;

            // „É¨„É≥„Ç∫ÁîªÂÉèË®≠ÂÆö
            document.getElementById('leftLens').src = question.imageUrl;
            document.getElementById('rightLens').src = question.imageUrl;

            // ÈÅ∏ÊäûËÇ¢Ë°®Á§∫
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            optionsContainer.setAttribute('role', 'radiogroup');
            optionsContainer.setAttribute('aria-label', '„Ç´„É©„Ç≥„É≥„ÅÆÈÅ∏ÊäûËÇ¢');

            question.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.dataset.oid = option.oid;
                div.dataset.index = index;
                div.setAttribute('role', 'radio');
                div.setAttribute('aria-checked', 'false');
                div.setAttribute('tabindex', '0');
                div.setAttribute('aria-label', `ÈÅ∏ÊäûËÇ¢${index + 1}: ${option.label}`);
                div.innerHTML = `
                    <div class="answer-radio" aria-hidden="true"></div>
                    <div>${option.label}</div>
                `;
                div.addEventListener('click', () => selectOption(index, option.oid));
                div.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectOption(index, option.oid);
                    }
                });
                optionsContainer.appendChild(div);
            });

            // „Éí„É≥„Éà„É™„Çª„ÉÉ„Éà
            hintsUsed = { h1: false, h2: false };
            document.getElementById('hint1Btn').classList.remove('used');
            document.getElementById('hint2Btn').classList.remove('used');
            document.getElementById('hintDisplay').classList.remove('show');
            document.getElementById('hintDisplay').textContent = '';

            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            startTimer();

            // ÈÅ∏Êäû„É™„Çª„ÉÉ„Éà
            selectedAnswer = null;
        }

        // ÈÅ∏ÊäûËÇ¢ÈÅ∏Êäû
        function selectOption(index, oid) {
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.setAttribute('aria-checked', 'false');
            });

            const selected = document.querySelector(`[data-index="${index}"]`);
            if (selected) {
                selected.classList.add('selected');
                selected.setAttribute('aria-checked', 'true');
                selectedAnswer = index;
            }
        }

        // „Çø„Ç§„Éû„Éº
        function startTimer() {
            timeLeft = 20;
            clearInterval(timer);

            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').textContent = timeLeft;

                if (timeLeft <= 5) {
                    document.getElementById('timer').classList.add('warning');
                } else {
                    document.getElementById('timer').classList.remove('warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitAnswer(true); // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Éï„É©„Ç∞
                }
            }, 1000);
        }

        // ÂõûÁ≠îÈÄÅ‰ø°
        function submitAnswer(isTimeout = false) {
            clearInterval(timer);

            const question = quizData[currentQuestionIndex];
            const isCorrect = selectedAnswer !== null && question.options[selectedAnswer].isCorrect;

            answers.push({
                qid: question.qid,
                selectedIndex: selectedAnswer,
                isCorrect: isCorrect,
                tMs: (20 - timeLeft) * 1000,
                h1: hintsUsed.h1,
                h2: hintsUsed.h2,
                isTimeout: isTimeout
            });

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
            showAnswerFeedback(isCorrect, question, isTimeout);

            currentQuestionIndex++;

            // 2ÁßíÂæå„Å´Ê¨°„ÅÆÂïèÈ°å„Å∏
            setTimeout(() => {
                hideFeedback();
                loadQuestion();
            }, 2000);
        }

        // ÂõûÁ≠î„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØË°®Á§∫
        function showAnswerFeedback(isCorrect, question, isTimeout = false) {
            const overlay = document.getElementById('feedbackOverlay');
            const card = document.getElementById('feedbackCard');
            const icon = document.getElementById('feedbackIcon');
            const title = document.getElementById('feedbackTitle');
            const message = document.getElementById('feedbackMessage');
            const imageDiv = document.getElementById('feedbackImage');

            card.className = 'feedback-card';

            if (isCorrect) {
                card.classList.add('feedback-correct');
                icon.textContent = 'üéâ';
                title.textContent = 'Ê≠£Ëß£ÔºÅ';
                message.textContent = question.correctLabel;

                // Ê≠£Ëß£ÊôÇ„ÅØÁîªÂÉè„ÇÇË°®Á§∫
                imageDiv.innerHTML = `<img src="${question.thumbUrl}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`;
            } else {
                card.classList.add('feedback-incorrect');
                if (isTimeout) {
                    icon.textContent = '‚è∞';
                    title.textContent = '„Çø„Ç§„É†„Ç¢„Ç¶„Éà';
                    message.textContent = `Ê≠£Ëß£: ${question.correctLabel}`;
                } else {
                    icon.textContent = '‚ùå';
                    title.textContent = '‰∏çÊ≠£Ëß£';
                    message.textContent = `Ê≠£Ëß£: ${question.correctLabel}`;
                }
                imageDiv.innerHTML = '';
            }

            overlay.classList.remove('hidden');
        }

        function hideFeedback() {
            document.getElementById('feedbackOverlay').classList.add('hidden');
        }

        // „ÇØ„Ç§„Ç∫ÁµÇ‰∫Ü
        function finishQuiz() {
            const correctCount = answers.filter(a => a.isCorrect).length;
            const wrongCount = answers.filter(a => !a.isCorrect).length;
            const hintCount = answers.reduce((sum, a) => sum + (a.h1 ? 1 : 0) + (a.h2 ? 1 : 0), 0);

            // „Çπ„Ç≥„Ç¢Ë®àÁÆó (100% - ‰∏çÊ≠£Ëß£√ó10% - „Éí„É≥„Éà√ó3%)
            const baseScore = 100;
            const wrongPenalty = wrongCount * 10;
            const hintPenalty = hintCount * 3;
            const finalScore = Math.max(0, Math.min(100, baseScore - wrongPenalty - hintPenalty));

            document.getElementById('finalScore').textContent = finalScore;
            document.getElementById('correctCount').textContent = correctCount;

            // Áµ±Ë®àÊõ¥Êñ∞
            updateUserStats(finalScore, correctCount);

            showPage('resultPage');
        }

        // „É¶„Éº„Ç∂„ÉºÁµ±Ë®àÊõ¥Êñ∞
        function updateUserStats(score, correct) {
            const currentPoints = parseInt(document.getElementById('userPoints').textContent) || 0;
            const newPoints = currentPoints + Math.floor(score / 10);
            document.getElementById('userPoints').textContent = newPoints;

            const todayBest = parseInt(document.getElementById('todayBest').textContent) || 0;
            if (score > todayBest) {
                document.getElementById('todayBest').textContent = score;
            }
        }

        // „Éí„É≥„ÉàË°®Á§∫
        function showHint(hintType) {
            const question = quizData[currentQuestionIndex];
            if (!question) return;

            if (hintType === 'h1' && !hintsUsed.h1) {
                hintsUsed.h1 = true;
                document.getElementById('hint1Btn').classList.add('used');

                const display = document.getElementById('hintDisplay');
                display.textContent = question.hints.h1;
                display.classList.add('show');
            } else if (hintType === 'h2' && !hintsUsed.h2) {
                hintsUsed.h2 = true;
                document.getElementById('hint2Btn').classList.add('used');

                const display = document.getElementById('hintDisplay');
                const current = display.textContent;
                display.textContent = current ? `${current}\n${question.hints.h2}` : question.hints.h2;
                display.classList.add('show');
            }
        }

        // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫
        function showRanking() {
            showPage('rankingPage');

            // „ÉÄ„Éü„Éº„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø
            const rankings = [
                { name: 'Â±±Áî∞Ëä±Â≠ê', score: 95, playCount: 15 },
                { name: '‰ΩêËó§ÁæéÂí≤', score: 92, playCount: 12 },
                { name: 'Áî∞‰∏≠„ÅÇ„ÅÑ', score: 88, playCount: 18 },
                { name: 'Èà¥Êú®„ÇÜ„Çä', score: 85, playCount: 9 },
                { name: 'È´òÊ©ã„Åø„Åä', score: 82, playCount: 22 },
                { name: currentUser ? currentUser.name : '„ÅÇ„Å™„Åü', score: 78, playCount: 5 }
            ];

            let html = '<div style="background: #FFF3E0; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;"><strong>üèÜ TOP 10</strong></div>';

            rankings.forEach((player, index) => {
                const rank = index + 1;
                const medal = rank <= 3 ? ['ü•á', 'ü•à', 'ü•â'][rank - 1] : `${rank}‰Ωç`;
                const isUser = currentUser && player.name === currentUser.name;

                html += `
                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; ${isUser ? 'background: #FFF0F8;' : ''}">
                        <div style="font-size: 18px; width: 50px;">${medal}</div>
                        <div style="flex: 1;">
                            ${player.name}${isUser ? ' („ÅÇ„Å™„Åü)' : ''}
                            <div style="font-size: 12px; color: #999;">${player.playCount}Âõû„Éó„É¨„Ç§</div>
                        </div>
                        <div style="font-weight: bold; color: #FF6EC7;">${player.score}ÁÇπ</div>
                    </div>
                `;
            });

            document.getElementById('rankingList').innerHTML = html;
        }

        // „Éû„Ç§ÊàêÁ∏æË°®Á§∫
        function showMyPage() {
            showPage('myPage');

            // „ÉÄ„Éü„Éº„Éá„Éº„Çø
            const stats = {
                averageScore: 78,
                totalPlays: 12,
                todayBest: document.getElementById('todayBest').textContent,
                recentScores: [85, 72, 91, 65, 88]
            };

            let html = `
                <div class="stats-grid">
                    <div class="stat-card" style="background: #E3F2FD;">
                        <div style="font-size: 24px; font-weight: bold; color: #1565C0;">${stats.averageScore}</div>
                        <div style="font-size: 12px; color: #666;">Âπ≥Âùá„Çπ„Ç≥„Ç¢</div>
                    </div>
                    <div class="stat-card" style="background: #F3E5F5;">
                        <div style="font-size: 24px; font-weight: bold; color: #7B1FA2;">${stats.totalPlays}</div>
                        <div style="font-size: 12px; color: #666;">„Éó„É¨„Ç§ÂõûÊï∞</div>
                    </div>
                    <div class="stat-card" style="background: #FFF3E0;">
                        <div style="font-size: 24px; font-weight: bold; color: #F57C00;">${stats.todayBest}</div>
                        <div style="font-size: 12px; color: #666;">‰ªäÊó•„ÅÆ„Éô„Çπ„Éà</div>
                    </div>
                </div>
                <h3 style="margin-bottom: 12px;">üìà ÊúÄËøë„ÅÆÊàêÁ∏æ</h3>
            `;

            stats.recentScores.forEach((score, index) => {
                const date = new Date();
                date.setDate(date.getDate() - (stats.recentScores.length - 1 - index));

                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span>${date.toLocaleDateString('ja-JP')}</span>
                        <span style="font-weight: bold; color: #FF6EC7;">${score}ÁÇπ</span>
                    </div>
                `;
            });

            document.getElementById('myStats').innerHTML = html;
        }

        function restartQuiz() {
            startQuiz(gameMode);
        }

        // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº
        window.addEventListener('error', function(e) {
            console.error('„Ç∞„É≠„Éº„Éê„É´JavaScript„Ç®„É©„Éº:', e.error);
            return true; // „Ç®„É©„Éº„ÇíÂá¶ÁêÜÊ∏à„Åø„Å®„Åó„Å¶„Éû„Éº„ÇØ
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Êú™Âá¶ÁêÜ„ÅÆPromiseÊãíÂê¶:', e.reason);
            e.preventDefault(); // „Éá„Éï„Ç©„É´„Éà„ÅÆÂá¶ÁêÜ„ÇíÈò≤Ê≠¢
            return true;
        });

        // ChromeÊã°ÂºµÊ©üËÉΩÈñ¢ÈÄ£„Ç®„É©„Éº„ÇíÁÑ°Ë¶ñ
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');

            // ChromeÊã°ÂºµÊ©üËÉΩÈñ¢ÈÄ£„ÅÆ„Ç®„É©„Éº„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            if (message.includes('runtime.lastError') ||
                message.includes('message port closed') ||
                message.includes('extension port') ||
                message.includes('back/forward cache')) {
                return; // Ë°®Á§∫„Åó„Å™„ÅÑ
            }

            // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº„ÅØÈÄöÂ∏∏ÈÄö„ÇäË°®Á§∫
            originalConsoleError.apply(console, args);
        };

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', function() {
            console.log('„Ç¢„Éó„É™Ëµ∑Âãï');

            // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥ÔºàOAuthÂØæÂøúÔºâ
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                // OAuth URL„ÇíË®≠ÂÆöÔºàÂÆüÈöõ„ÅÆURL„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑÔºâ
                const AUTH_URL = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&response_type=code&scope=email%20profile';

                loginBtn.addEventListener('click', () => {
                    // Êàª„Å£„Å¶„Åç„ÅüÊôÇ„ÅÆ„Åü„ÇÅ„ÅÆ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
                    sessionStorage.setItem('login_flow', 'started');

                    // Âç≥Â∫ß„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„ÉàÔºàawait„ÇÑfetch„Å™„Å©„ÅÆÈùûÂêåÊúüÂá¶ÁêÜ„ÅØÂÖ•„Çå„Å™„ÅÑÔºâ
                    window.top.location.href = AUTH_URL;
                });
            }

            // Enter„Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
            const userNameInput = document.getElementById('userName');
            if (userNameInput) {
                userNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }

            // „É°„Éã„É•„Éº„Éú„Çø„É≥
            const startDailyBtn = document.getElementById('startDailyBtn');
            const startPracticeBtn = document.getElementById('startPracticeBtn');
            const rankingBtn = document.getElementById('rankingBtn');
            const myPageBtn = document.getElementById('myPageBtn');

            if (startDailyBtn) {
                startDailyBtn.addEventListener('click', () => startQuiz('daily'));
            }

            if (startPracticeBtn) {
                startPracticeBtn.addEventListener('click', () => startQuiz('practice'));
            }

            if (rankingBtn) {
                rankingBtn.addEventListener('click', showRanking);
            }

            if (myPageBtn) {
                myPageBtn.addEventListener('click', showMyPage);
            }

            // „Éí„É≥„Éà„Éú„Çø„É≥
            const hint1Btn = document.getElementById('hint1Btn');
            const hint2Btn = document.getElementById('hint2Btn');

            if (hint1Btn) {
                hint1Btn.addEventListener('click', () => showHint('h1'));
            }

            if (hint2Btn) {
                hint2Btn.addEventListener('click', () => showHint('h2'));
            }

            // ÂõûÁ≠î„Éú„Çø„É≥
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => submitAnswer());
            }
        });
    </script>
</body>
</html>