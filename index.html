<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz☆カラコンアカデミア</title>
    <style>
        /* 基本リセット */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(180deg, #fff2f7, #fffafc);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }
        .shell { max-width: 480px; margin: 0 auto; }
        .hidden { display: none !important; }
        /* --- 以下、主要なスタイル (省略) --- */
        .hero { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .logo { width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #FF6EC7, #FF9472); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
        .hero-text h1 { font-size: 18px; }
        .card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input { width: 100%; padding: 14px 16px; border: 2px solid #E0E0E0; border-radius: 12px; font-size: 16px; }
        .btn { padding: 16px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #FF6EC7, #FF9472); color: white; }
        .btn-secondary { background: #E3F2FD; color: #1565C0; }
        .quiz-header { background: linear-gradient(135deg, #FF6EC7, #FF9472); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .quiz-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .progress-bar { background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { background: white; height: 100%; transition: width 0.5s ease; }
        .lens-display { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .lens-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #FFD2EC; }
        .answer-options { display: grid; gap: 12px; }
        .answer-option { background: white; border: 2px solid #E0E0E0; border-radius: 12px; padding: 16px; cursor: pointer; }
        .answer-option.selected { border-color: #FF6EC7; background: #FFE3F2; }
        .feedback-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .feedback-card { background: white; padding: 32px; border-radius: 24px; text-align: center; }
        .feedback-correct { border: 4px solid #4CAF50; }
        .feedback-incorrect { border: 4px solid #F44336; }
    </style>
</head>
<body>
    <div class="shell">
        <!-- ログイン画面 -->
        <div id="loginPage" class="page">
            <div class="card">
                <h2>ログイン</h2>
                <div class="input-group">
                    <label for="staffId">会員番号</label>
                    <input type="text" id="staffId" placeholder="例：ST001">
                </div>
                <div class="input-group">
                    <label for="userName">会員名</label>
                    <input type="text" id="userName" placeholder="例：山田花子">
                </div>
                <button id="loginBtn" class="btn btn-primary">ログイン</button>
            </div>
        </div>

        <!-- ホーム画面 -->
        <div id="homePage" class="page hidden">
            <div class="card">
                 <h2>ホーム</h2>
                 <p id="welcomeMessage"></p>
                 <button id="startPracticeBtn" class="btn btn-secondary">練習モード開始</button>
            </div>
        </div>

        <!-- クイズ画面 -->
        <div id="quizPage" class="page hidden">
            <div class="quiz-header">
                <div class="quiz-info">
                    <div>Question <span id="currentQuestionNum">1</span>/10</div>
                    <div id="timer">⏱ <span id="timeLeft">20</span>秒</div>
                </div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
            </div>
            <div class="card">
                <div class="lens-display">
                    <img class="lens-image" id="leftLens" alt="レンズ画像1">
                    <img class="lens-image" id="rightLens" alt="レンズ画像2">
                </div>
                <div class="answer-options" id="answerOptions"></div>
                <button class="btn btn-primary" id="submitBtn">回答する</button>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="resultPage" class="page hidden">
            <div class="card">
                <h2>結果</h2>
                <p>スコア: <span id="finalScore">0</span>点</p>
                <button id="homeBtn" class="btn btn-primary">ホームへ戻る</button>
            </div>
        </div>
        
        <!-- フィードバック表示 -->
        <div id="feedbackOverlay" class="feedback-overlay hidden">
            <div class="feedback-card" id="feedbackCard">
                <div id="feedbackTitle" style="font-size: 24px; font-weight: bold;"></div>
                <div id="feedbackMessage"></div>
            </div>
        </div>
    </div>

    <script>
    // ===================================================================
    // アプリケーションメインスクリプト (単一ファイル版)
    // ===================================================================
    const App = (() => {
        'use strict';

        // --- 状態管理 ---
        const state = {
            currentUser: null,
            quizData: null,
            currentQuestionIndex: 0,
            selectedAnswerKey: null,
            answers: [],
            timer: null,
            timeLeft: 20
        };

        // --- DOM要素キャッシュ ---
        const UI = {
            pages: {
                login: document.getElementById('loginPage'),
                home: document.getElementById('homePage'),
                quiz: document.getElementById('quizPage'),
                result: document.getElementById('resultPage')
            },
            buttons: {
                login: document.getElementById('loginBtn'),
                startPractice: document.getElementById('startPracticeBtn'),
                submit: document.getElementById('submitBtn'),
                toHome: document.getElementById('homeBtn')
            },
            quiz: {
                currentNum: document.getElementById('currentQuestionNum'),
                progressFill: document.getElementById('progressFill'),
                timeLeft: document.getElementById('timeLeft'),
                leftLens: document.getElementById('leftLens'),
                rightLens: document.getElementById('rightLens'),
                optionsContainer: document.getElementById('answerOptions')
            },
            feedback: {
                overlay: document.getElementById('feedbackOverlay'),
                card: document.getElementById('feedbackCard'),
                title: document.getElementById('feedbackTitle'),
                message: document.getElementById('feedbackMessage')
            },
            welcomeMessage: document.getElementById('welcomeMessage')
        };

        // --- ページ表示 ---
        function showPage(pageId) {
            Object.values(UI.pages).forEach(p => p.classList.add('hidden'));
            if (UI.pages[pageId]) {
                UI.pages[pageId].classList.remove('hidden');
            }
        }

        // --- ログイン処理 ---
        function handleLogin() {
            const staffId = document.getElementById('staffId').value;
            const userName = document.getElementById('userName').value;
            if (!staffId || !userName) {
                alert('会員番号と会員名を入力してください。');
                return;
            }
            state.currentUser = { staffId, name: userName };
            UI.welcomeMessage.textContent = `${userName}さん、ようこそ！`;
            showPage('home');
        }

        // --- クイズ開始 ---
        function startQuiz() {
            showPage('quiz');
            UI.quiz.optionsContainer.innerHTML = '<p>問題を取得中です...</p>';

            google.script.run
                .withSuccessHandler(onQuestionsLoaded)
                .withFailureHandler(onQuestionsFailed)
                .getQuestions({ count: 10 });
        }

        function onQuestionsLoaded(questions) {
            if (!questions || questions.length === 0) {
                return onQuestionsFailed({ message: 'サーバーから問題を取得できませんでした。' });
            }
            state.quizData = questions;
            state.currentQuestionIndex = 0;
            state.answers = [];
            loadQuestion();
        }

        function onQuestionsFailed(error) {
            alert('エラー: ' + error.message);
            showPage('home');
        }

        // --- 問題読み込み ---
        function loadQuestion() {
            if (state.currentQuestionIndex >= state.quizData.length) {
                return finishQuiz();
            }
            const q = state.quizData[state.currentQuestionIndex];
            
            UI.quiz.currentNum.textContent = state.currentQuestionIndex + 1;
            UI.quiz.progressFill.style.width = `${(state.currentQuestionIndex + 1) * 10}%`;
            
            setImgSafe(UI.quiz.leftLens, q.imgL, 'Lens');
            setImgSafe(UI.quiz.rightLens, q.imgR, 'Lens');

            const optsContainer = UI.quiz.optionsContainer;
            optsContainer.innerHTML = '';
            q.options.forEach(optionKey => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.dataset.key = optionKey;
                div.textContent = optionKey;
                div.onclick = () => selectOption(div);
                optsContainer.appendChild(div);
            });

            state.selectedAnswerKey = null;
            startTimer();
        }

        function selectOption(el) {
            document.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            state.selectedAnswerKey = el.dataset.key;
        }
        
        // --- タイマー ---
        function startTimer() {
            state.timeLeft = 20;
            UI.quiz.timeLeft.textContent = state.timeLeft;
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                state.timeLeft--;
                UI.quiz.timeLeft.textContent = state.timeLeft;
                if (state.timeLeft <= 0) {
                    submitAnswer(true);
                }
            }, 1000);
        }

        // --- 回答処理 ---
        function submitAnswer(isTimeout = false) {
            clearInterval(state.timer);
            const q = state.quizData[state.currentQuestionIndex];
            const isCorrect = !isTimeout && state.selectedAnswerKey === q.correctAnswer;

            showFeedback(isCorrect, isTimeout, q.correctAnswer);
            
            setTimeout(() => {
                UI.feedback.overlay.classList.add('hidden');
                state.currentQuestionIndex++;
                loadQuestion();
            }, 2000);
        }

        function showFeedback(isCorrect, isTimeout, correctLabel) {
            const fb = UI.feedback;
            fb.overlay.classList.remove('hidden');
            fb.card.className = 'feedback-card';
            
            if (isTimeout) {
                fb.title.textContent = 'タイムアウト';
                fb.message.textContent = `正解: ${correctLabel}`;
            } else if (isCorrect) {
                fb.card.classList.add('feedback-correct');
                fb.title.textContent = '正解！';
                fb.message.textContent = correctLabel;
            } else {
                fb.card.classList.add('feedback-incorrect');
                fb.title.textContent = '不正解';
                fb.message.textContent = `正解: ${correctLabel}`;
            }
        }
        
        function finishQuiz() {
            showPage('result');
            document.getElementById('finalScore').textContent = '計算中...'; // ここでスコア計算
        }

        // --- 画像エラー処理 ---
        function inlinePlaceholder(text) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect width="100%" height="100%" fill="#FFD2EC"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="#333">${text || 'Lens'}</text></svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        function setImgSafe(el, url, label) {
            if (!el) return;
            el.onerror = function(){ this.onerror=null; this.src = inlinePlaceholder(label); };
            el.src = url || inlinePlaceholder(label);
        }

        // --- 初期化 ---
        function init() {
            UI.buttons.login.onclick = handleLogin;
            UI.buttons.startPractice.onclick = startQuiz;
            UI.buttons.submit.onclick = () => submitAnswer(false);
            UI.buttons.toHome.onclick = () => showPage('home');
            
            showPage('login'); // ★★★★★ アプリ起動時は必ずログイン画面から開始
            console.log('アプリケーションが初期化されました。');
        }

        return { init };
    })();

    document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>

