<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quizâ˜†ã‚«ãƒ©ã‚³ãƒ³ã‚¢ã‚«ãƒ‡ãƒŸã‚¢</title>
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€ã“ã“ã§ã¯çœç•¥ã—ã¾ã™ */
        body { font-family: sans-serif; background: #fff2f7; }
        .hidden { display: none !important; }
        /* (ä»¥ä¸‹ã€å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒç¶šãã¾ã™) */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        .shell { max-width: 480px; margin: 0 auto; padding: 20px; }
        .hero { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding: 16px; background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .logo { width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #FF6EC7, #FF9472); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
        .hero-text h1 { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 4px; }
        .api { color: #999; font-size: 12px; }
        .card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .card h2 { margin-bottom: 20px; color: #333; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #666; font-size: 14px; font-weight: 500; }
        input { width: 100%; padding: 14px 16px; border: 2px solid #E0E0E0; border-radius: 12px; font-size: 16px; background: white; transition: border-color 0.2s ease; }
        input:focus { outline: none; border-color: #FF6EC7; box-shadow: 0 0 0 3px rgba(255, 110, 199, 0.1); }
        .btn { padding: 16px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s ease; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #FF6EC7, #FF9472); color: white; box-shadow: 0 4px 12px rgba(255, 110, 199, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 110, 199, 0.4); }
        .quiz-header { background: linear-gradient(135deg, #FF6EC7, #FF9472); color: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; }
        .quiz-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .timer { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .timer.warning { background: #FF4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .progress-bar { background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { background: white; height: 100%; transition: width 0.5s ease; }
        .lens-container { text-align: center; margin-bottom: 24px; }
        .lens-label { font-size: 16px; color: #666; margin-bottom: 20px; font-weight: 500; }
        .lens-display { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .lens-image { width: 120px; height: 120px; border-radius: 50%; box-shadow: 0 8px 24px rgba(0,0,0,0.15); object-fit: cover; border: 4px solid #FFD2EC; }
        .hint-buttons { display: flex; gap: 12px; margin-bottom: 20px; }
        .hint-btn { flex: 1; padding: 12px 16px; background: #FFF0F8; border: 2px solid #FFD2EC; border-radius: 12px; color: #FF6EC7; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease; }
        .hint-btn:hover { background: #FFE3F2; }
        .hint-btn.used { background: #FFD2EC; opacity: 0.6; cursor: not-allowed; }
        .hint-display { display: none; background: #FFF9E6; border: 2px solid #FFE59E; border-radius: 12px; padding: 16px; margin-bottom: 20px; color: #8B6914; font-size: 14px; white-space: pre-line; line-height: 1.6; }
        .hint-display.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .answer-options { display: grid; gap: 12px; margin-bottom: 24px; }
        .answer-option { background: white; border: 2px solid #E0E0E0; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 12px; }
        .answer-option:hover { border-color: #FF6EC7; background: #FFF0F8; transform: translateY(-1px); }
        .answer-option.selected { border-color: #FF6EC7; background: #FFE3F2; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 110, 199, 0.2); }
        .feedback-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s ease; }
        .feedback-card { background: white; padding: 32px; border-radius: 24px; text-align: center; max-width: 320px; margin: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.3); animation: scaleIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .feedback-correct { border: 4px solid #4CAF50; }
        .feedback-incorrect { border: 4px solid #F44336; }
    </style>
</head>
<body>
    <div class="shell">
        <!-- ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥ -->
        <div id="loginPage" class="page">
            <div class="card">
                <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="input-group">
                    <label for="staffId">ä¼šå“¡ç•ªå·</label>
                    <input type="text" id="staffId" placeholder="ä¾‹ï¼šST001">
                </div>
                <div class="input-group">
                    <label for="userName">ä¼šå“¡å</label>
                    <input type="text" id="userName" placeholder="ä¾‹ï¼šå±±ç”°èŠ±å­">
                </div>
                <button id="loginBtn" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>

        <div id="homePage" class="page hidden">
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ã®HTML... -->
            <button id="startPracticeBtn" class="btn btn-primary">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
        </div>

        <div id="quizPage" class="page hidden">
            <div class="quiz-header">
                <div class="quiz-info">
                    <div>Question <span id="currentQuestionNum">1</span>/10</div>
                    <div class="timer" id="timer">â± <span id="timeLeft">20</span>ç§’</div>
                </div>
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 10%;"></div></div>
            </div>
            <div class="card">
                <div class="lens-container">
                    <div class="lens-label">ã“ã®ã‚«ãƒ©ã‚³ãƒ³ã¯ä½•ï¼Ÿ</div>
                    <div class="lens-display">
                        <img class="lens-image" id="leftLens" alt="å·¦ãƒ¬ãƒ³ã‚º">
                        <img class="lens-image" id="rightLens" alt="å³ãƒ¬ãƒ³ã‚º">
                    </div>
                </div>
                <div class="hint-buttons">
                    <button class="hint-btn" id="hint1Btn">ğŸ’¡ ãƒ’ãƒ³ãƒˆ1</button>
                    <button class="hint-btn" id="hint2Btn">ğŸ’¡ ãƒ’ãƒ³ãƒˆ2</button>
                </div>
                <div class="hint-display" id="hintDisplay"></div>
                <div class="answer-options" id="answerOptions"></div>
                <button class="btn btn-primary" id="submitBtn">å›ç­”ã™ã‚‹</button>
            </div>
        </div>

        <div id="resultPage" class="page hidden">
            <!-- çµæœç”»é¢ã®HTML... -->
        </div>

        <div id="feedbackOverlay" class="feedback-overlay hidden">
            <div class="feedback-card" id="feedbackCard">
                <div id="feedbackIcon" style="font-size: 48px;"></div>
                <div id="feedbackTitle" style="font-size: 24px; font-weight: bold;"></div>
                <div id="feedbackMessage"></div>
            </div>
        </div>
    </div>

    <script>
    // ===================================================================
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    // ===================================================================
    const App = (() => {
        'use strict';

        // --- çŠ¶æ…‹ç®¡ç† ---
        const state = {
            currentUser: null,
            quizData: null,
            currentQuestionIndex: 0,
            selectedAnswerKey: null,
            answers: [],
            timer: null,
            timeLeft: 20,
            hintsUsed: { h1: false, h2: false },
            gameMode: 'practice'
        };

        // --- DOMè¦ç´  ---
        const DOMElements = {
            pages: {
                login: document.getElementById('loginPage'),
                home: document.getElementById('homePage'),
                quiz: document.getElementById('quizPage'),
                result: document.getElementById('resultPage')
            },
            quiz: {
                currentNum: document.getElementById('currentQuestionNum'),
                progressFill: document.getElementById('progressFill'),
                timeLeft: document.getElementById('timeLeft'),
                timer: document.getElementById('timer'),
                leftLens: document.getElementById('leftLens'),
                rightLens: document.getElementById('rightLens'),
                hint1Btn: document.getElementById('hint1Btn'),
                hint2Btn: document.getElementById('hint2Btn'),
                hintDisplay: document.getElementById('hintDisplay'),
                optionsContainer: document.getElementById('answerOptions'),
                submitBtn: document.getElementById('submitBtn')
            },
            feedback: {
                overlay: document.getElementById('feedbackOverlay'),
                card: document.getElementById('feedbackCard'),
                icon: document.getElementById('feedbackIcon'),
                title: document.getElementById('feedbackTitle'),
                message: document.getElementById('feedbackMessage')
            }
        };

        // --- é–¢æ•° ---
        function showPage(pageId) {
            Object.values(DOMElements.pages).forEach(p => p.classList.add('hidden'));
            const page = DOMElements.pages[pageId];
            if (page) page.classList.remove('hidden');
        }

        function startQuiz(mode) {
            state.gameMode = mode;
            showPage('quiz');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            DOMElements.quiz.optionsContainer.innerHTML = '<p>å•é¡Œã‚’å–å¾—ä¸­...</p>';

            google.script.run
                .withSuccessHandler(onQuestionsLoaded)
                .withFailureHandler(onQuestionsFailed)
                .getQuestions({ count: 10 });
        }

        function onQuestionsLoaded(questions) {
            if (!questions || !questions.length) {
                onQuestionsFailed({ message: 'å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚' });
                return;
            }
            state.quizData = questions;
            state.currentQuestionIndex = 0;
            state.answers = [];
            loadQuestion();
        }

        function onQuestionsFailed(error) {
            alert('å•é¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            showPage('home');
        }

        function loadQuestion() {
            if (state.currentQuestionIndex >= state.quizData.length) {
                finishQuiz();
                return;
            }
            const q = state.quizData[state.currentQuestionIndex];
            
            // UIæ›´æ–°
            DOMElements.quiz.currentNum.textContent = state.currentQuestionIndex + 1;
            DOMElements.quiz.progressFill.style.width = `${(state.currentQuestionIndex + 1) * 10}%`;
            
            // ç”»åƒè¨­å®š (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ä»˜ã)
            setImgSafe(DOMElements.quiz.leftLens, q.imgL, 'Lens');
            setImgSafe(DOMElements.quiz.rightLens, q.imgR, 'Lens');

            // é¸æŠè‚¢
            const opts = DOMElements.quiz.optionsContainer;
            opts.innerHTML = '';
            q.options.forEach(optionKey => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.dataset.key = optionKey;
                div.textContent = optionKey;
                div.onclick = () => selectOption(div);
                opts.appendChild(div);
            });

            // ãƒ’ãƒ³ãƒˆã¨ã‚¿ã‚¤ãƒãƒ¼ã®ãƒªã‚»ãƒƒãƒˆ
            resetHints();
            startTimer();
            state.selectedAnswerKey = null;
        }

        function selectOption(el) {
            document.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            state.selectedAnswerKey = el.dataset.key;
        }

        function startTimer() {
            state.timeLeft = 20;
            DOMElements.quiz.timeLeft.textContent = state.timeLeft;
            DOMElements.quiz.timer.classList.remove('warning');
            clearInterval(state.timer);
            state.timer = setInterval(() => {
                state.timeLeft--;
                DOMElements.quiz.timeLeft.textContent = state.timeLeft;
                if (state.timeLeft <= 5) DOMElements.quiz.timer.classList.add('warning');
                if (state.timeLeft <= 0) submitAnswer(true);
            }, 1000);
        }

        function submitAnswer(isTimeout = false) {
            clearInterval(state.timer);
            const q = state.quizData[state.currentQuestionIndex];
            const isCorrect = !isTimeout && state.selectedAnswerKey === q.correctAnswer;

            showFeedback(isCorrect, isTimeout, q.correctAnswer);
            
            setTimeout(() => {
                DOMElements.feedback.overlay.classList.add('hidden');
                state.currentQuestionIndex++;
                loadQuestion();
            }, 2000);
        }

        function showFeedback(isCorrect, isTimeout, correctLabel) {
            const fb = DOMElements.feedback;
            fb.overlay.classList.remove('hidden');
            fb.card.className = 'feedback-card'; // reset classes
            if (isTimeout) {
                fb.card.classList.add('feedback-timeout'); // To be styled
                fb.icon.textContent = 'â°';
                fb.title.textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ';
            } else if (isCorrect) {
                fb.card.classList.add('feedback-correct');
                fb.icon.textContent = 'ğŸ‰';
                fb.title.textContent = 'æ­£è§£ï¼';
            } else {
                fb.card.classList.add('feedback-incorrect');
                fb.icon.textContent = 'âŒ';
                fb.title.textContent = 'ä¸æ­£è§£';
            }
            fb.message.textContent = isCorrect ? correctLabel : `æ­£è§£: ${correctLabel}`;
        }
        
        function finishQuiz() {
            showPage('result');
            // ã“ã“ã«çµæœè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
        }
        
        function resetHints() {
            state.hintsUsed = { h1: false, h2: false };
            [DOMElements.quiz.hint1Btn, DOMElements.quiz.hint2Btn].forEach(b => b.classList.remove('used'));
            DOMElements.quiz.hintDisplay.classList.remove('show');
            DOMElements.quiz.hintDisplay.textContent = '';
        }

        function setupEventListeners() {
            document.getElementById('loginBtn').onclick = () => {
                state.currentUser = { staffId: document.getElementById('staffId').value };
                showPage('home');
            };
            document.getElementById('startPracticeBtn').onclick = () => startQuiz('practice');
            DOMElements.quiz.submitBtn.onclick = () => submitAnswer(false);
        }
        
        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            showPage('login');
        });

        // --- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç”»åƒç”Ÿæˆ ---
        function inlinePlaceholder(text){
            text = text || 'Lens';
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect width="100%" height="100%" fill="#FFD2EC"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="#333">${text}</text></svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        function setImgSafe(el, url, label){
            if (!el) return;
            el.onerror = function(){ this.onerror=null; this.src = inlinePlaceholder(label); };
            el.src = url || inlinePlaceholder(label);
        }
    })();
    </script>
    <script>
/**
 * Frontend override v2
 * ç›®çš„ï¼š
 *  - ãƒ€ãƒŸãƒ¼å•é¡Œã®ç”Ÿæˆã‚’åœæ­¢ã—ã€GASã® getQuestions ã‚’å¿…ãšå‘¼ã¶
 *  - ç”»åƒã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã§å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³(via.placeholder.com)ã‚’ä½¿ã‚ãªã„ï¼ˆdata URIã§å†…è”µï¼‰
 * ä½¿ã„æ–¹ï¼š index.html ã® </body> ç›´å‰ã« <script src="quiz-override.js"></script> ã¨ã—ã¦èª­ã¿è¾¼ã‚€
 */
(function() {
    'use strict';

    // ãƒ­ã‚°å‡ºåŠ›ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function log() {
        try {
            console.log.apply(console, ['[quiz-hook]'].concat([].slice.call(arguments)));
        } catch(e) {
            // ãƒ­ã‚°å‡ºåŠ›ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
    }

    // å…ƒã® startQuiz é–¢æ•°ã‚’ä¿å­˜
    const _origStart = window.startQuiz;

    /**
     * data URIãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ç”Ÿæˆï¼ˆå¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ã‚ãªã„ï¼‰
     * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} data URIå½¢å¼ã®ç”»åƒ
     */
    function inlinePlaceholder(text) {
        text = text || 'Lens';
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
            <defs>
                <radialGradient id="g">
                    <stop offset="0%" stop-color="#ffd1dc"/>
                    <stop offset="100%" stop-color="#ff88aa"/>
                </radialGradient>
            </defs>
            <rect width="100%" height="100%" fill="url(#g)"/>
            <circle cx="100" cy="100" r="70" fill="rgba(255,255,255,0.6)"/>
            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                  font-size="20" font-family="Noto Sans JP, sans-serif" fill="#333">${text}</text>
        </svg>`;
        return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‚ç…§å¯èƒ½ï¼‰
    window.__lensPlaceholder = inlinePlaceholder;

    /**
     * imgè¦ç´ ã«ç”»åƒURLã‚’å®‰å…¨ã«è¨­å®šï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è¡¨ç¤ºï¼‰
     * @param {HTMLImageElement} el - å¯¾è±¡ã®imgè¦ç´ 
     * @param {string} url - è¨­å®šã™ã‚‹ç”»åƒURL
     * @param {string} label - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã®ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
     */
    function setImgSafe(el, url, label) {
        if (!el) return;

        el.onerror = function() {
            this.onerror = null;
            this.src = inlinePlaceholder(label || 'Lens');
        };

        el.src = url || inlinePlaceholder(label || 'Lens');
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.__setImgSafe = setImgSafe;

    /**
     * GASã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹
     * @param {number} count - å–å¾—ã™ã‚‹å•é¡Œæ•°
     */
    function startQuizFromSheets(count) {
        const questionCount = count || 10;

        // Google Apps Script APIã®å­˜åœ¨ç¢ºèª
        if (!window.google || !google.script || !google.script.run) {
            alert('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆgoogle.script.run æœªå®šç¾©ï¼‰ã€‚GAS ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
            if (typeof _origStart === 'function') {
                return _origStart();
            }
            return;
        }

        log('fetching questions from GAS...', questionCount);

        // GASã‹ã‚‰å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        google.script.run
            .withSuccessHandler(function(list) {
                try {
                    // ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
                    if (!list || !list.length) {
                        log('empty questions -> fallback');
                        if (typeof _origStart === 'function') {
                            return _origStart();
                        }
                        return;
                    }

                    // æ—¢å­˜UIã®å½¢å¼ã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿å¤‰æ›
                    const questions = list.map(function(q) {
                        return {
                            id: q.questionId,
                            prompt: q.prompt || 'ã“ã®ã‚«ãƒ©ã‚³ãƒ³ã¯ä½•ï¼Ÿ',
                            imageLeft: q.imgL,
                            imageRight: q.imgR || q.imgL,
                            options: q.options,
                            correctAnswer: q.correctAnswer,
                            hints: [q.hint1, q.hint2].filter(Boolean)
                        };
                    });

                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆã«è¨­å®š
                    window.App = window.App || {};
                    App.state = App.state || {};
                    App.state.questions = questions;
                    App.state.totalQuestions = questions.length;
                    App.state.currentIndex = 0;

                    // ã‚¯ã‚¤ã‚ºé–‹å§‹å‡¦ç†
                    if (typeof _origStart === 'function') {
                        _origStart();
                    } else if (typeof window.loadQuestion === 'function') {
                        window.loadQuestion(0);
                    }

                    log('quiz started with sheet data:', questions.length);

                } catch(e) {
                    console.error('Error processing quiz data:', e);
                    if (typeof _origStart === 'function') {
                        return _origStart();
                    }
                }
            })
            .withFailureHandler(function(err) {
                console.error('Failed to fetch questions:', err);
                alert('å•é¡Œå–å¾—ã«å¤±æ•—: ' + (err && err.message ? err.message : err));
                if (typeof _origStart === 'function') {
                    return _origStart();
                }
            })
            .getQuestions({ count: questionCount });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.startQuizFromSheets = startQuizFromSheets;

    // æ—¢å­˜ã® startQuiz ã‚’ç½®ãæ›ãˆ
    window.startQuiz = function() {
        return startQuizFromSheets(10);
    };

    // loadQuestion ã®ãƒ‘ãƒƒãƒï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€URLã®ç½®æ›ï¼‰
    const _origLoadQuestion = window.loadQuestion;

    window.loadQuestion = function(index) {
        // å…ƒã®é–¢æ•°ã‚’å®Ÿè¡Œ
        if (typeof _origLoadQuestion === 'function') {
            _origLoadQuestion(index);
        }

        try {
            // ãƒ¬ãƒ³ã‚ºç”»åƒè¦ç´ ã®å–å¾—
            const leftLens = document.querySelector(
                '[data-role="lens-left"], #lensLeft, .lens-left img, #imgLeft, #leftLens'
            );
            const rightLens = document.querySelector(
                '[data-role="lens-right"], #lensRight, .lens-right img, #imgRight, #rightLens'
            );

            if (window.App && App.state && App.state.questions) {
                // GASãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
                const currentIndex = index || App.state.currentIndex || 0;
                const question = App.state.questions[currentIndex];

                if (question) {
                    setImgSafe(leftLens, question.imageLeft, 'Lens');
                    setImgSafe(rightLens, question.imageRight, 'Lens');
                }
            } else {
                // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’data URIã«ç½®æ›
                if (leftLens && /via\.placeholder\.com/.test(leftLens.src)) {
                    leftLens.src = inlinePlaceholder('Lens');
                }
                if (rightLens && /via\.placeholder\.com/.test(rightLens.src)) {
                    rightLens.src = inlinePlaceholder('Lens');
                }
            }
        } catch(e) {
            console.warn('[quiz-hook] load patch skipped:', e);
        }
    };

    // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
    log('Quiz override initialized');

})();
</script>
</body>
</html>