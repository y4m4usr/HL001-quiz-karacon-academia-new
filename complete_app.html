<!DOCTYPE html>
<html lang="ja">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="robots" content="noindex, nofollow">
    <title>ãƒ›ãƒ†ãƒ©ãƒ presents Quizâ˜†ã‚«ãƒ©ã‚³ãƒ³ã‚¢ã‚«ãƒ‡ãƒŸã‚¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(180deg, #fff2f7, #fffafc);
            min-height: 100vh;
            padding: 20px;
        }

        .shell {
            max-width: 480px;
            margin: 0 auto;
        }

        .hero {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 12px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .logo {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FF6EC7, #FF9472);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        h1 {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .api {
            color: #999;
            font-size: 12px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #FF6EC7;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6EC7, #FF9472);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* ã‚¯ã‚¤ã‚ºç”»é¢ */
        .quiz-header {
            background: linear-gradient(135deg, #FF6EC7, #FF9472);
            color: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timer {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
        }

        .timer.warning {
            background: #FF4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.5s ease;
        }

        /* ãƒ¬ãƒ³ã‚ºè¡¨ç¤º */
        .lens-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .lens-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .lens-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .lens-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            object-fit: cover;
            border: 3px solid #FFD2EC;
        }

        /* ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³ */
        .hint-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .hint-btn {
            flex: 1;
            padding: 12px;
            background: #FFF0F8;
            border: 2px solid #FFD2EC;
            border-radius: 12px;
            color: #FF6EC7;
            cursor: pointer;
            font-weight: bold;
        }

        .hint-btn.used {
            background: #FFD2EC;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hint-display {
            display: none;
            background: #FFF9E6;
            border: 2px solid #FFE59E;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            color: #8B6914;
            font-size: 14px;
            white-space: pre-line;
        }

        .hint-display.show {
            display: block;
        }

        /* é¸æŠè‚¢ */
        .answer-options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .answer-option {
            background: white;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .answer-option:hover {
            border-color: #FF6EC7;
            background: #FFF0F8;
        }

        .answer-option.selected {
            border-color: #FF6EC7;
            background: #FFE3F2;
        }

        .answer-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #E0E0E0;
            border-radius: 50%;
            position: relative;
        }

        .answer-option.selected .answer-radio {
            border-color: #FF6EC7;
        }

        .answer-option.selected .answer-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #FF6EC7;
            border-radius: 50%;
        }

        .hidden {
            display: none !important;
        }

        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .feedback-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
            margin: 20px;
        }

        .feedback-correct {
            border: 4px solid #4CAF50;
        }

        .feedback-incorrect {
            border: 4px solid #F44336;
        }

        .feedback-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="shell">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="hero">
            <div class="logo">ğŸ‘ï¸</div>
            <div>
                <h1>Quizâ˜†ã‚«ãƒ©ã‚³ãƒ³ã‚¢ã‚«ãƒ‡ãƒŸã‚¢</h1>
                <div class="api">ãƒ›ãƒ†ãƒ©ãƒ presents v1.5</div>
            </div>
        </div>

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginPage" class="page">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="input-group">
                    <label for="staffId">ã‚¹ã‚¿ãƒƒãƒ•ç•ªå·</label>
                    <input type="text" id="staffId" name="staffId" placeholder="ä¾‹ï¼šST001" value="ST001" autocomplete="username" aria-describedby="staffId-help">
                    <small id="staffId-help" style="color: #666; font-size: 12px;">ä¾‹ï¼šST001</small>
                </div>
                <div class="input-group">
                    <label for="userName">ãŠåå‰</label>
                    <input type="text" id="userName" name="userName" placeholder="ä¾‹ï¼šå±±ç”°èŠ±å­" value="ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼" autocomplete="name" aria-describedby="userName-help">
                    <small id="userName-help" style="color: #666; font-size: 12px;">ãƒ•ãƒ«ãƒãƒ¼ãƒ ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                </div>
                <button id="loginBtn" class="btn btn-primary" type="button" aria-label="ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>

        <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
        <div id="homePage" class="page hidden">
            <div class="card" style="background: linear-gradient(135deg, #FF6EC7, #FF9472); color: white;">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <div style="width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px;">ğŸ‘¤</div>
                    <div>
                        <div style="font-size: 20px; font-weight: bold;" id="displayName">-</div>
                        <div style="font-size: 14px;">Lv.5 ã‚¹ã‚¿ãƒƒãƒ•</div>
                    </div>
                </div>
                <div class="stats-grid" style="background: rgba(255,255,255,0.2); padding: 16px; border-radius: 12px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="userPoints">850</div>
                        <div style="font-size: 12px;">ãƒã‚¤ãƒ³ãƒˆ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="userStreak">7æ—¥</div>
                        <div style="font-size: 12px;">é€£ç¶š</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;" id="todayBest">-</div>
                        <div style="font-size: 12px;">æœ¬æ—¥</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <button id="startDailyBtn" class="btn btn-primary" type="button" aria-label="ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é–‹å§‹ã™ã‚‹ - 1æ—¥1å›é™å®šã®æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰">ğŸ“… ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
                    <button id="startPracticeBtn" class="btn" type="button" style="background: #E3F2FD; color: #1565C0; border: 2px solid #90CAF9;" aria-label="ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã™ã‚‹ - ç„¡åˆ¶é™ã§ç·´ç¿’ã§ãã¾ã™">ğŸ¯ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button id="rankingBtn" class="btn" type="button" style="background: #FFF3E0; color: #F57C00; border: 2px solid #FFB74D;" aria-label="ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ - å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®æˆç¸¾é †ä½">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
                    <button id="myPageBtn" class="btn" type="button" style="background: #F3E5F5; color: #7B1FA2; border: 2px solid #CE93D8;" aria-label="ãƒã‚¤æˆç¸¾ã‚’è¡¨ç¤ºã™ã‚‹ - å€‹äººã®çµ±è¨ˆã¨å±¥æ­´">ğŸ“Š ãƒã‚¤æˆç¸¾</button>
                </div>
            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div id="quizPage" class="page hidden">
            <div class="quiz-header">
                <div class="quiz-info">
                    <div>Question <span id="currentQuestionNum">1</span>/10</div>
                    <div class="timer" id="timer">
                        <span>â±</span>
                        <span id="timeLeft">20</span>ç§’
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 10%;"></div>
                </div>
            </div>

            <div class="card">
                <div class="lens-container">
                    <div class="lens-label">ã“ã®ã‚«ãƒ©ã‚³ãƒ³ã¯ä½•ï¼Ÿ</div>
                    <div class="lens-display">
                        <img class="lens-image" id="leftLens" src="" alt="å·¦ãƒ¬ãƒ³ã‚º">
                        <img class="lens-image" id="rightLens" src="" alt="å³ãƒ¬ãƒ³ã‚º">
                    </div>
                </div>

                <div class="hint-buttons">
                    <button class="hint-btn" id="hint1Btn" type="button" aria-label="ãƒ’ãƒ³ãƒˆ1ã‚’è¡¨ç¤ºã™ã‚‹ - DIAã€G.DIAã€BCã®æƒ…å ±">ğŸ’¡ ãƒ’ãƒ³ãƒˆ1</button>
                    <button class="hint-btn" id="hint2Btn" type="button" aria-label="ãƒ’ãƒ³ãƒˆ2ã‚’è¡¨ç¤ºã™ã‚‹ - å•†å“ã®è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆ">ğŸ’¡ ãƒ’ãƒ³ãƒˆ2</button>
                </div>

                <div class="hint-display" id="hintDisplay"></div>

                <div class="answer-options" id="answerOptions">
                    <!-- é¸æŠè‚¢ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>

                <button class="btn btn-primary" id="submitBtn" type="button" aria-label="é¸æŠã—ãŸå›ç­”ã‚’é€ä¿¡ã™ã‚‹">å›ç­”ã™ã‚‹</button>
            </div>
        </div>

        <!-- çµæœç”»é¢ -->
        <div id="resultPage" class="page hidden">
            <div class="card" style="text-align: center;">
                <h2 style="color: #FF6EC7; margin-bottom: 20px;">ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h2>
                <div style="font-size: 48px; margin: 20px 0;">ğŸ‰</div>
                <p style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">
                    ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span>ç‚¹
                </p>
                <p style="color: #666; margin-bottom: 20px;">
                    10å•ä¸­ <span id="correctCount">0</span>å•æ­£è§£
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn btn-primary" type="button" onclick="showPage('homePage')" aria-label="ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
                    <button class="btn" type="button" style="background: #E3F2FD; color: #1565C0;" onclick="restartQuiz()" aria-label="åŒã˜ãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ã‚¤ã‚ºã‚’ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹">ã‚‚ã†ä¸€åº¦</button>
                </div>
            </div>
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ -->
        <div id="rankingPage" class="page hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                <div id="rankingList"></div>
                <button class="btn btn-primary" type="button" onclick="showPage('homePage')" aria-label="ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- ãƒã‚¤æˆç¸¾ç”»é¢ -->
        <div id="myPage" class="page hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“Š ãƒã‚¤æˆç¸¾</h2>
                <div id="myStats"></div>
                <button class="btn btn-primary" type="button" onclick="showPage('homePage')" aria-label="ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º -->
        <div id="feedbackOverlay" class="feedback-overlay hidden">
            <div class="feedback-card" id="feedbackCard">
                <div class="feedback-icon" id="feedbackIcon">ğŸ‰</div>
                <div id="feedbackTitle" style="font-size: 24px; font-weight: bold; margin-bottom: 12px;">æ­£è§£ï¼</div>
                <div id="feedbackMessage" style="color: #666;">ã‚ˆãã§ãã¾ã—ãŸ</div>
                <div id="feedbackImage" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>

    <script>
        // æ—©æœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° - Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼ã‚’ç„¡åŠ¹åŒ–
        (function() {
            // Chrome runtime ã‚¨ãƒ©ãƒ¼ã‚’æ•æ‰ã—ã¦ç„¡è¦–ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã¾ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
            // é€šå¸¸ã®Webãƒšãƒ¼ã‚¸ã§ã¯ chrome.runtime ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“
            /*
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                const originalAddListener = chrome.runtime.onMessage ? chrome.runtime.onMessage.addListener : null;
                if (originalAddListener) {
                    chrome.runtime.onMessage.addListener = function(callback) {
                        return originalAddListener.call(this, function(request, sender, sendResponse) {
                            try {
                                const result = callback(request, sender, sendResponse);
                                if (result === true) {
                                    return true; // éåŒæœŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
                                }
                                return result;
                            } catch (e) {
                                console.warn('Message listener error caught and ignored:', e);
                                return false;
                            }
                        });
                    };
                }
            }
            */

            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const originalError = console.error;
            console.error = function(...args) {
                const message = String(args[0] || '');
                if (message.includes('runtime.lastError') ||
                    message.includes('extension port') ||
                    message.includes('message port closed') ||
                    message.includes('back/forward cache') ||
                    message.includes('Unrecognized feature') ||
                    message.includes('sandbox')) {
                    return;
                }
                originalError.apply(console, args);
            };

            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = String(args[0] || '');
                if (message.includes('Unrecognized feature') ||
                    message.includes('sandbox') ||
                    message.includes('iframe')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        })();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentUser = null;
        let quizData = null;
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let answers = [];
        let timer = null;
        let timeLeft = 20;
        let hintsUsed = { h1: false, h2: false };
        let quizId = null;
        let gameMode = 'practice';

        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(function(page) {
                page.classList.add('hidden');
            });

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        function handleLogin() {
            console.log('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹');

            const staffId = document.getElementById('staffId').value.trim();
            const userName = document.getElementById('userName').value.trim();

            if (!staffId || !userName) {
                alert('ã‚¹ã‚¿ãƒƒãƒ•ç•ªå·ã¨ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            currentUser = {
                staffId: staffId,
                name: userName,
                role: 'role_baito'
            };

            document.getElementById('displayName').textContent = userName;
            showPage('homePage');

            console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentUser);
        }

        // ãƒ€ãƒŸãƒ¼ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateDummyQuestions() {
            const questions = [];
            const sampleOptions = [
                'ãƒ€ã‚¹ãƒ†ã‚£ãƒ†ã‚£ãƒ¼ï½œç‹‚æ„›ãƒ–ãƒ©ã‚¦ãƒ³',
                'ã‚¢ã‚¤ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆï½œãƒ›ãƒ­ãƒ–ãƒ©ã‚¦ãƒ³',
                'ãƒãƒ‹ãƒ¼ã‚­ã‚¹ï½œã¡ã‚…ã‚‹ã‚“ãƒ–ãƒ©ã‚¦ãƒ³',
                'ãƒŸãƒ¼ã‚¯ãƒ¬ãƒ¼ãƒ«ï½œã‚ã–ã¨ãƒ–ãƒ©ã‚¦ãƒ³'
            ];

            for (let i = 0; i < 10; i++) {
                const correctIndex = Math.floor(Math.random() * sampleOptions.length);
                const correctLabel = sampleOptions[correctIndex];

                // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                const shuffledOptions = [...sampleOptions].sort(() => Math.random() - 0.5);

                questions.push({
                    qid: `q${String(i+1).padStart(3, '0')}`,
                    correctAnswer: correctIndex,
                    correctLabel: correctLabel,
                    imageUrl: 'https://via.placeholder.com/150/FFB6C1/000000?text=Lens${i+1}',
                    thumbUrl: 'https://via.placeholder.com/80/90CAF9/000000?text=OK${i+1}',
                    options: shuffledOptions.map((label, idx) => ({
                        oid: `o${String(idx+1).padStart(3, '0')}`,
                        label: label,
                        isCorrect: label === correctLabel
                    })),
                    hints: {
                        h1: `DIA:14.${3+i%8} / G.DIA:13.${2+i%6} / BC:8.${4+i%4}`,
                        h2: ['ãƒ•ãƒã§ç³ã‚’ãã£ãã‚Šè¦‹ã›ã¤ã¤ã€ä¸­å¿ƒéƒ¨ã®é€æ˜æ„Ÿã§ã€Œã†ã‚‹ãƒ„ãƒ¤ã€åŠ¹æœã‚’æ¼”å‡º',
                             'ãƒŠãƒãƒ¥ãƒ©ãƒ«ãªç™ºè‰²ã§ç³ã«æº¶ã‘è¾¼ã‚€ã‚ˆã†ãªãƒ‡ã‚¶ã‚¤ãƒ³',
                             'å¤§äººã£ã½ã„å°è±¡ã‚’ä¸ãˆã‚‹è½ã¡ç€ã„ãŸã‚«ãƒ©ãƒ¼',
                             'å¯æ„›ã‚‰ã—ã•ã‚’æ¼”å‡ºã™ã‚‹ç”˜ã‚ã®ç™ºè‰²'][i%4]
                    }
                });
            }

            return questions;
        }

        // ã‚¯ã‚¤ã‚ºé–‹å§‹
        function startQuiz(mode = 'practice') {
            console.log('ã‚¯ã‚¤ã‚ºé–‹å§‹:', mode);
            gameMode = mode;

            quizData = generateDummyQuestions();
            quizId = 'quiz_' + Date.now();
            currentQuestionIndex = 0;
            answers = [];

            showPage('quizPage');
            loadQuestion();
        }

        // å•é¡Œèª­ã¿è¾¼ã¿
        function loadQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                finishQuiz();
                return;
            }

            const question = quizData[currentQuestionIndex];

            // å•é¡Œç•ªå·æ›´æ–°
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('progressFill').style.width = `${((currentQuestionIndex + 1) / 10) * 100}%`;

            // ãƒ¬ãƒ³ã‚ºç”»åƒè¨­å®š
            document.getElementById('leftLens').src = question.imageUrl;
            document.getElementById('rightLens').src = question.imageUrl;

            // é¸æŠè‚¢è¡¨ç¤º
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            optionsContainer.setAttribute('role', 'radiogroup');
            optionsContainer.setAttribute('aria-label', 'ã‚«ãƒ©ã‚³ãƒ³ã®é¸æŠè‚¢');

            question.options.forEach((option, index) => {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.dataset.oid = option.oid;
                div.dataset.index = index;
                div.setAttribute('role', 'radio');
                div.setAttribute('aria-checked', 'false');
                div.setAttribute('tabindex', '0');
                div.setAttribute('aria-label', `é¸æŠè‚¢${index + 1}: ${option.label}`);
                div.innerHTML = `
                    <div class="answer-radio" aria-hidden="true"></div>
                    <div>${option.label}</div>
                `;
                div.addEventListener('click', () => selectOption(index, option.oid));
                div.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectOption(index, option.oid);
                    }
                });
                optionsContainer.appendChild(div);
            });

            // ãƒ’ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
            hintsUsed = { h1: false, h2: false };
            document.getElementById('hint1Btn').classList.remove('used');
            document.getElementById('hint2Btn').classList.remove('used');
            document.getElementById('hintDisplay').classList.remove('show');
            document.getElementById('hintDisplay').textContent = '';

            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startTimer();

            // é¸æŠãƒªã‚»ãƒƒãƒˆ
            selectedAnswer = null;
        }

        // é¸æŠè‚¢é¸æŠ
        function selectOption(index, oid) {
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.setAttribute('aria-checked', 'false');
            });

            const selected = document.querySelector(`[data-index="${index}"]`);
            if (selected) {
                selected.classList.add('selected');
                selected.setAttribute('aria-checked', 'true');
                selectedAnswer = index;
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼
        function startTimer() {
            timeLeft = 20;
            clearInterval(timer);

            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timeLeft').textContent = timeLeft;

                if (timeLeft <= 5) {
                    document.getElementById('timer').classList.add('warning');
                } else {
                    document.getElementById('timer').classList.remove('warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    submitAnswer(true); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ•ãƒ©ã‚°
                }
            }, 1000);
        }

        // å›ç­”é€ä¿¡
        function submitAnswer(isTimeout = false) {
            clearInterval(timer);

            const question = quizData[currentQuestionIndex];
            const isCorrect = selectedAnswer !== null && question.options[selectedAnswer].isCorrect;

            answers.push({
                qid: question.qid,
                selectedIndex: selectedAnswer,
                isCorrect: isCorrect,
                tMs: (20 - timeLeft) * 1000,
                h1: hintsUsed.h1,
                h2: hintsUsed.h2,
                isTimeout: isTimeout
            });

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            showAnswerFeedback(isCorrect, question, isTimeout);

            currentQuestionIndex++;

            // 2ç§’å¾Œã«æ¬¡ã®å•é¡Œã¸
            setTimeout(() => {
                hideFeedback();
                loadQuestion();
            }, 2000);
        }

        // å›ç­”ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showAnswerFeedback(isCorrect, question, isTimeout = false) {
            const overlay = document.getElementById('feedbackOverlay');
            const card = document.getElementById('feedbackCard');
            const icon = document.getElementById('feedbackIcon');
            const title = document.getElementById('feedbackTitle');
            const message = document.getElementById('feedbackMessage');
            const imageDiv = document.getElementById('feedbackImage');

            card.className = 'feedback-card';

            if (isCorrect) {
                card.classList.add('feedback-correct');
                icon.textContent = 'ğŸ‰';
                title.textContent = 'æ­£è§£ï¼';
                message.textContent = question.correctLabel;

                // æ­£è§£æ™‚ã¯ç”»åƒã‚‚è¡¨ç¤º
                imageDiv.innerHTML = `<img src="${question.thumbUrl}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`;
            } else {
                card.classList.add('feedback-incorrect');
                if (isTimeout) {
                    icon.textContent = 'â°';
                    title.textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ';
                    message.textContent = `æ­£è§£: ${question.correctLabel}`;
                } else {
                    icon.textContent = 'âŒ';
                    title.textContent = 'ä¸æ­£è§£';
                    message.textContent = `æ­£è§£: ${question.correctLabel}`;
                }
                imageDiv.innerHTML = '';
            }

            overlay.classList.remove('hidden');
        }

        function hideFeedback() {
            document.getElementById('feedbackOverlay').classList.add('hidden');
        }

        // ã‚¯ã‚¤ã‚ºçµ‚äº†
        function finishQuiz() {
            const correctCount = answers.filter(a => a.isCorrect).length;
            const wrongCount = answers.filter(a => !a.isCorrect).length;
            const hintCount = answers.reduce((sum, a) => sum + (a.h1 ? 1 : 0) + (a.h2 ? 1 : 0), 0);

            // ã‚¹ã‚³ã‚¢è¨ˆç®— (100% - ä¸æ­£è§£Ã—10% - ãƒ’ãƒ³ãƒˆÃ—3%)
            const baseScore = 100;
            const wrongPenalty = wrongCount * 10;
            const hintPenalty = hintCount * 3;
            const finalScore = Math.max(0, Math.min(100, baseScore - wrongPenalty - hintPenalty));

            document.getElementById('finalScore').textContent = finalScore;
            document.getElementById('correctCount').textContent = correctCount;

            // çµ±è¨ˆæ›´æ–°
            updateUserStats(finalScore, correctCount);

            showPage('resultPage');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæ›´æ–°
        function updateUserStats(score, correct) {
            const currentPoints = parseInt(document.getElementById('userPoints').textContent) || 0;
            const newPoints = currentPoints + Math.floor(score / 10);
            document.getElementById('userPoints').textContent = newPoints;

            const todayBest = parseInt(document.getElementById('todayBest').textContent) || 0;
            if (score > todayBest) {
                document.getElementById('todayBest').textContent = score;
            }
        }

        // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        function showHint(hintType) {
            const question = quizData[currentQuestionIndex];
            if (!question) return;

            if (hintType === 'h1' && !hintsUsed.h1) {
                hintsUsed.h1 = true;
                document.getElementById('hint1Btn').classList.add('used');

                const display = document.getElementById('hintDisplay');
                display.textContent = question.hints.h1;
                display.classList.add('show');
            } else if (hintType === 'h2' && !hintsUsed.h2) {
                hintsUsed.h2 = true;
                document.getElementById('hint2Btn').classList.add('used');

                const display = document.getElementById('hintDisplay');
                const current = display.textContent;
                display.textContent = current ? `${current}\n${question.hints.h2}` : question.hints.h2;
                display.classList.add('show');
            }
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        function showRanking() {
            showPage('rankingPage');

            // ãƒ€ãƒŸãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿
            const rankings = [
                { name: 'å±±ç”°èŠ±å­', score: 95, playCount: 15 },
                { name: 'ä½è—¤ç¾å’²', score: 92, playCount: 12 },
                { name: 'ç”°ä¸­ã‚ã„', score: 88, playCount: 18 },
                { name: 'éˆ´æœ¨ã‚†ã‚Š', score: 85, playCount: 9 },
                { name: 'é«˜æ©‹ã¿ãŠ', score: 82, playCount: 22 },
                { name: currentUser ? currentUser.name : 'ã‚ãªãŸ', score: 78, playCount: 5 }
            ];

            let html = '<div style="background: #FFF3E0; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;"><strong>ğŸ† TOP 10</strong></div>';

            rankings.forEach((player, index) => {
                const rank = index + 1;
                const medal = rank <= 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][rank - 1] : `${rank}ä½`;
                const isUser = currentUser && player.name === currentUser.name;

                html += `
                    <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; ${isUser ? 'background: #FFF0F8;' : ''}">
                        <div style="font-size: 18px; width: 50px;">${medal}</div>
                        <div style="flex: 1;">
                            ${player.name}${isUser ? ' (ã‚ãªãŸ)' : ''}
                            <div style="font-size: 12px; color: #999;">${player.playCount}å›ãƒ—ãƒ¬ã‚¤</div>
                        </div>
                        <div style="font-weight: bold; color: #FF6EC7;">${player.score}ç‚¹</div>
                    </div>
                `;
            });

            document.getElementById('rankingList').innerHTML = html;
        }

        // ãƒã‚¤æˆç¸¾è¡¨ç¤º
        function showMyPage() {
            showPage('myPage');

            // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
            const stats = {
                averageScore: 78,
                totalPlays: 12,
                todayBest: document.getElementById('todayBest').textContent,
                recentScores: [85, 72, 91, 65, 88]
            };

            let html = `
                <div class="stats-grid">
                    <div class="stat-card" style="background: #E3F2FD;">
                        <div style="font-size: 24px; font-weight: bold; color: #1565C0;">${stats.averageScore}</div>
                        <div style="font-size: 12px; color: #666;">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                    </div>
                    <div class="stat-card" style="background: #F3E5F5;">
                        <div style="font-size: 24px; font-weight: bold; color: #7B1FA2;">${stats.totalPlays}</div>
                        <div style="font-size: 12px; color: #666;">ãƒ—ãƒ¬ã‚¤å›æ•°</div>
                    </div>
                    <div class="stat-card" style="background: #FFF3E0;">
                        <div style="font-size: 24px; font-weight: bold; color: #F57C00;">${stats.todayBest}</div>
                        <div style="font-size: 12px; color: #666;">ä»Šæ—¥ã®ãƒ™ã‚¹ãƒˆ</div>
                    </div>
                </div>
                <h3 style="margin-bottom: 12px;">ğŸ“ˆ æœ€è¿‘ã®æˆç¸¾</h3>
            `;

            stats.recentScores.forEach((score, index) => {
                const date = new Date();
                date.setDate(date.getDate() - (stats.recentScores.length - 1 - index));

                html += `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span>${date.toLocaleDateString('ja-JP')}</span>
                        <span style="font-weight: bold; color: #FF6EC7;">${score}ç‚¹</span>
                    </div>
                `;
            });

            document.getElementById('myStats').innerHTML = html;
        }

        function restartQuiz() {
            startQuiz(gameMode);
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        window.addEventListener('error', function(e) {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«JavaScriptã‚¨ãƒ©ãƒ¼:', e.error);
            return true; // ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', e.reason);
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‡¦ç†ã‚’é˜²æ­¢
            return true;
        });

        // Chromeæ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');

            // Chromeæ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (message.includes('runtime.lastError') ||
                message.includes('message port closed') ||
                message.includes('extension port') ||
                message.includes('back/forward cache')) {
                return; // è¡¨ç¤ºã—ãªã„
            }

            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯é€šå¸¸é€šã‚Šè¡¨ç¤º
            originalConsoleError.apply(console, args);
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ã‚¢ãƒ—ãƒªèµ·å‹•');

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼ˆOAuthå¯¾å¿œï¼‰
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                // OAuth URLã‚’è¨­å®šï¼ˆå®Ÿéš›ã®URLã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
                const AUTH_URL = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&response_type=code&scope=email%20profile';

                loginBtn.addEventListener('click', () => {
                    // æˆ»ã£ã¦ããŸæ™‚ã®ãŸã‚ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                    sessionStorage.setItem('login_flow', 'started');

                    // å³åº§ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆawaitã‚„fetchãªã©ã®éåŒæœŸå‡¦ç†ã¯å…¥ã‚Œãªã„ï¼‰
                    window.top.location.href = AUTH_URL;
                });
            }

            // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
            const userNameInput = document.getElementById('userName');
            if (userNameInput) {
                userNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleLogin();
                    }
                });
            }

            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
            const startDailyBtn = document.getElementById('startDailyBtn');
            const startPracticeBtn = document.getElementById('startPracticeBtn');
            const rankingBtn = document.getElementById('rankingBtn');
            const myPageBtn = document.getElementById('myPageBtn');

            if (startDailyBtn) {
                startDailyBtn.addEventListener('click', () => startQuiz('daily'));
            }

            if (startPracticeBtn) {
                startPracticeBtn.addEventListener('click', () => startQuiz('practice'));
            }

            if (rankingBtn) {
                rankingBtn.addEventListener('click', showRanking);
            }

            if (myPageBtn) {
                myPageBtn.addEventListener('click', showMyPage);
            }

            // ãƒ’ãƒ³ãƒˆãƒœã‚¿ãƒ³
            const hint1Btn = document.getElementById('hint1Btn');
            const hint2Btn = document.getElementById('hint2Btn');

            if (hint1Btn) {
                hint1Btn.addEventListener('click', () => showHint('h1'));
            }

            if (hint2Btn) {
                hint2Btn.addEventListener('click', () => showHint('h2'));
            }

            // å›ç­”ãƒœã‚¿ãƒ³
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => submitAnswer());
            }
        });
    </script>
</body>
</html>